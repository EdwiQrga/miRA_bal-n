<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realidad Aumentada - Jugador de Fútbol</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; text-align: center; }
    #videoElement, #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    #modelContainer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background-color: rgba(0,0,0,0.9); }
    iframe { width: 100%; height: 100%; border: none; }
    #volverBtn { position: absolute; top: 10px; right: 10px; z-index: 3; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <video id="videoElement" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="modelContainer">
    <iframe id="modelViewer" src="https://sketchfab.com/models/5311ede6883c4fb39f366f86559f58de/embed" allow="autoplay; fullscreen; vr"></iframe>
    <button id="volverBtn">Volver a la cámara</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script>
    const video = document.getElementById("videoElement");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const modelContainer = document.getElementById("modelContainer");
    const volverBtn = document.getElementById("volverBtn");

    let model, isDetected = false;

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve(video);
      });
    }

    function drawBox(pred, color = "#00FF00", label = "") {
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.strokeRect(pred.bbox[0], pred.bbox[1], pred.bbox[2], pred.bbox[3]);
      ctx.fillStyle = color;
      ctx.font = "18px Arial";
      ctx.fillText(`${label} (${Math.round(pred.score * 100)}%)`, pred.bbox[0], pred.bbox[1] > 20 ? pred.bbox[1] - 5 : 10);
    }

    function showModel() {
      modelContainer.style.display = "block";
    }

    function hideModel() {
      modelContainer.style.display = "none";
      isDetected = false;
    }

    volverBtn.addEventListener("click", hideModel);

    async function runDetection() {
      model = await cocoSsd.load();
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      setInterval(async () => {
        if (isDetected) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const predictions = await model.detect(video);

        predictions.forEach(pred => {
          if (pred.class === "sports ball" && pred.score > 0.6) {
            drawBox(pred, "#FF0000", "Balón");
            isDetected = true;
            showModel();
          }
        });
      }, 500);
    }

    async function startApp() {
      await initCamera();
      runDetection();
    }

    startApp();
  </script>
</body>
</html>